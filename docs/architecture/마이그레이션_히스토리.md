# Quantiq ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ íˆìŠ¤í† ë¦¬

## ë§ˆì´ê·¸ë ˆì´ì…˜ ê°œìš”

Quantiq ì‹œìŠ¤í…œì˜ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°ë¥¼ MongoDB ë‹¨ì¼ DBì—ì„œ **PostgreSQL + MongoDB í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜**ë¡œ ì „í™˜í•˜ì˜€ìŠµë‹ˆë‹¤.

## Phase 1: MongoDB Only (ì´ˆê¸° ë²„ì „)

### êµ¬ì¡°

```
MongoDB (stock_trading)
â”œâ”€ users (ì‚¬ìš©ì ì •ë³´)
â”œâ”€ stock_recommendations (ì¶”ì²œ ì‹ í˜¸)
â”œâ”€ trading (ê±°ë˜ ì´ë ¥)
â”œâ”€ balance (ì”ì•¡)
â”œâ”€ access_tokens (KIS API í† í°) âŒ ì œê±°ë¨
â””â”€ analysis_results (ë¶„ì„ ê²°ê³¼)
```

### ë¬¸ì œì 

1. **ê´€ê³„ ë¬´ê²°ì„± ë¶€ì¡±**: Foreign Key ì—†ì–´ ë°ì´í„° ì¼ê´€ì„± ë³´ì¥ ì–´ë ¤ì›€
2. **íŠ¸ëœì­ì…˜ ì œì•½**: ë³µì¡í•œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì œí•œì 
3. **ì¤‘ë³µ ë°ì´í„°**: ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì¤‘ë³µ ë°©ì§€ ë¡œì§ í•„ìš”
4. **êµ¬ì¡°í™” ë°ì´í„° ë¹„íš¨ìœ¨**: ì‚¬ìš©ì, ê³„ì • ì •ë³´ ê°™ì€ êµ¬ì¡°í™” ë°ì´í„°ì— ë¶€ì í•©

## Phase 2: PostgreSQL ë„ì… (í˜„ì¬)

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

**êµ¬ì¡°í™” ë°ì´í„° â†’ PostgreSQL**
- ëª…í™•í•œ ìŠ¤í‚¤ë§ˆê°€ ìˆëŠ” ë°ì´í„°
- ê´€ê³„ê°€ ì¤‘ìš”í•œ ë°ì´í„°
- ACID íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œ ë°ì´í„°

**ë¹„êµ¬ì¡°í™” ë°ì´í„° â†’ MongoDB**
- ìœ ì—°í•œ ìŠ¤í‚¤ë§ˆê°€ í•„ìš”í•œ ë°ì´í„°
- ë¶„ì„ ê²°ê³¼ ë“± ë³€ë™ì„± ë†’ì€ ë°ì´í„°
- JSON í˜•íƒœë¡œ ì €ì¥ì´ í¸ë¦¬í•œ ë°ì´í„°

### ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ

#### 1. Users í…Œì´ë¸” (V1)

```sql
-- MongoDB users ì»¬ë ‰ì…˜ â†’ PostgreSQL users í…Œì´ë¸”
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

**ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸**:
```python
# MongoDB â†’ PostgreSQL
for user in mongo_db.users.find():
    cursor.execute("""
        INSERT INTO users (user_id, email, password, created_at)
        VALUES (%s, %s, %s, %s)
        ON CONFLICT (user_id) DO NOTHING
    """, (user['userId'], user['email'], user['password'], user['createdAt']))
```

#### 2. User KIS Accounts (V2)

```sql
-- .envì˜ KIS ì •ë³´ â†’ PostgreSQL user_kis_accounts í…Œì´ë¸”
CREATE TABLE user_kis_accounts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    account_type VARCHAR(10) NOT NULL CHECK (account_type IN ('MOCK', 'REAL')),
    app_key VARCHAR(255) NOT NULL,
    app_secret_encrypted TEXT NOT NULL,
    account_number VARCHAR(50) NOT NULL,
    account_product_code VARCHAR(10) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, account_type)
);
```

**ë³€ê²½ ì‚¬í•­**:
- âŒ `.env` íŒŒì¼ì— í•˜ë“œì½”ë”© (KIS_APP_KEY, KIS_APP_SECRET)
- âœ… DBì— ì‚¬ìš©ìë³„ KIS ê³„ì • ì •ë³´ ì €ì¥
- âœ… ë©€í‹° ì‚¬ìš©ì ì§€ì› ê°€ëŠ¥
- âœ… MOCK/REAL ê³„ì • ë™ì‹œ ê´€ë¦¬

#### 3. Daily Stock Data (V3)

```sql
-- MongoDB stocks ì»¬ë ‰ì…˜ â†’ PostgreSQL daily_stock_data í…Œì´ë¸”
CREATE TABLE daily_stock_data (
    id BIGSERIAL PRIMARY KEY,
    ticker VARCHAR(20) NOT NULL,
    date DATE NOT NULL,
    open DECIMAL(12, 2) NOT NULL,
    high DECIMAL(12, 2) NOT NULL,
    low DECIMAL(12, 2) NOT NULL,
    close DECIMAL(12, 2) NOT NULL,
    volume BIGINT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE(ticker, date)
);
```

**ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸**:
```python
# MongoDB stocks â†’ PostgreSQL daily_stock_data
for stock in mongo_db.stocks.find():
    cursor.execute("""
        INSERT INTO daily_stock_data (ticker, date, open, high, low, close, volume)
        VALUES (%s, %s, %s, %s, %s, %s, %s)
        ON CONFLICT (ticker, date) DO NOTHING
    """, (stock['ticker'], stock['date'], stock['open'],
          stock['high'], stock['low'], stock['close'], stock['volume']))
```

#### 4. KIS Tokens (V5) â­ ìµœì‹ 

```sql
-- MongoDB access_tokens ì»¬ë ‰ì…˜ â†’ PostgreSQL kis_tokens í…Œì´ë¸”
CREATE TABLE kis_tokens (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    account_type VARCHAR(10) NOT NULL CHECK (account_type IN ('MOCK', 'REAL')),
    access_token TEXT NOT NULL,
    expiration_time TIMESTAMP NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, account_type)
);
```

**ë³€ê²½ ì´ìœ **:

| ê¸°ì¤€ | MongoDB | PostgreSQL |
|------|---------|------------|
| í† í° ì¤‘ë³µ ë°©ì§€ | ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ | DB UNIQUE ì œì•½ |
| ì‚¬ìš©ì ì—°ë™ | ì•½í•œ ì°¸ì¡° | Foreign Key |
| íŠ¸ëœì­ì…˜ | ì œí•œì  | ì™„ì „ ì§€ì› |
| ë§Œë£Œ í† í° ì •ë¦¬ | ìˆ˜ë™ ì¿¼ë¦¬ | ë¶€ë¶„ ì¸ë±ìŠ¤ |
| ìºì‹± ì„±ëŠ¥ | ì¢‹ìŒ | ë” ì¢‹ìŒ |

**ì½”ë“œ ë³€ê²½**:

```kotlin
// Before (MongoDB)
interface KisTokenRepository : MongoRepository<KisToken, String> {
    fun findByUserId(userId: String): KisToken?
}

// After (PostgreSQL + JPA)
interface KisTokenJpaRepository : JpaRepository<KisTokenEntity, Long> {
    @Query("""
        SELECT t FROM KisTokenEntity t
        JOIN t.user u
        WHERE u.userId = :userId
        AND t.accountType = :accountType
        AND t.isActive = true
        ORDER BY t.createdAt DESC
        LIMIT 1
    """)
    fun findLatestTokenByUserIdAndAccountType(
        userId: String,
        accountType: KisAccountType
    ): Optional<KisTokenEntity>
}
```

## í˜„ì¬ ì•„í‚¤í…ì²˜ (Phase 2)

### PostgreSQL (Primary - êµ¬ì¡°í™” ë°ì´í„°)

```
users                      â†â”€â”
â”œâ”€ id (PK)                    â”‚
â”œâ”€ user_id (UK)               â”‚
â”œâ”€ email                      â”‚
â””â”€ password                   â”‚
                              â”‚ FK
user_kis_accounts          â†â”€â”¤
â”œâ”€ id (PK)                    â”‚
â”œâ”€ user_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€ account_type
â”œâ”€ app_key
â””â”€ app_secret_encrypted       â”‚
                              â”‚ FK
kis_tokens                 â†â”€â”¤
â”œâ”€ id (PK)                    â”‚
â”œâ”€ user_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€ account_type
â”œâ”€ access_token
â””â”€ expiration_time

daily_stock_data
â”œâ”€ id (PK)
â”œâ”€ ticker
â”œâ”€ date
â”œâ”€ open, high, low, close
â””â”€ volume
```

### MongoDB (Secondary - ë¹„êµ¬ì¡°í™” ë°ì´í„°)

```
stock_recommendations
â”œâ”€ ticker
â”œâ”€ signal (BUY/SELL/HOLD)
â”œâ”€ confidence
â”œâ”€ indicators {...}
â””â”€ timestamp

trading
â”œâ”€ userId
â”œâ”€ ticker
â”œâ”€ side
â”œâ”€ quantity
â””â”€ executedAt

balance
â”œâ”€ userId
â”œâ”€ cash
â”œâ”€ holdings {...}
â””â”€ totalValue
```

## ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… ì™„ë£Œëœ ë§ˆì´ê·¸ë ˆì´ì…˜

- [x] V1: users í…Œì´ë¸” ìƒì„±
- [x] V2: user_kis_accounts í…Œì´ë¸” ìƒì„±
- [x] V3: daily_stock_data í…Œì´ë¸” ìƒì„±
- [x] V4: daily_stock_data ì¸ë±ìŠ¤ ì¶”ê°€
- [x] V5: kis_tokens í…Œì´ë¸” ìƒì„± â­ ìµœì‹ 
- [x] MongoDB access_tokens ì»¬ë ‰ì…˜ ì œê±°
- [x] MongoDB KisToken.kt íŒŒì¼ ì‚­ì œ
- [x] MongoDB KisTokenRepository.kt íŒŒì¼ ì‚­ì œ
- [x] KisApiAdapter.kt PostgreSQL ì „í™˜

### ğŸ”„ ì§„í–‰ ì¤‘

- [ ] kis_tokens ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ (í•„ìš”ì‹œ)
- [ ] Redis ìºì‹± ë ˆì´ì–´ ì¶”ê°€
- [ ] í† í° í”„ë¦¬íŒ¨ì¹­ ê¸°ëŠ¥

### ğŸ“‹ í–¥í›„ ê³„íš

- [ ] trading ì»¬ë ‰ì…˜ â†’ PostgreSQL ì „í™˜ ê²€í† 
- [ ] balance ì»¬ë ‰ì…˜ â†’ PostgreSQL ì „í™˜ ê²€í† 
- [ ] PostgreSQL Replication ì„¤ì •
- [ ] ë°±ì—…/ë³µêµ¬ ì „ëµ ìˆ˜ë¦½

## ë¡¤ë°± ê³„íš

### KIS Tokens PostgreSQL â†’ MongoDB ë¡¤ë°±

ë§Œì•½ ë¬¸ì œ ë°œìƒ ì‹œ MongoDBë¡œ ë¡¤ë°± ê°€ëŠ¥:

```kotlin
// 1. MongoDB ëª¨ë¸ ë³µêµ¬
data class KisToken(
    @Id val id: String? = null,
    val userId: String,
    val accountType: String,
    val accessToken: String,
    val expirationTime: LocalDateTime
)

// 2. Repository ë³µêµ¬
interface KisTokenRepository : MongoRepository<KisToken, String>

// 3. KisApiAdapter ì½”ë“œ ë³µêµ¬
private val tokenRepository: KisTokenRepository  // MongoDB

// 4. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
// PostgreSQL kis_tokens â†’ MongoDB access_tokens
```

## ì„±ëŠ¥ ë¹„êµ

### í† í° ì¡°íšŒ ì„±ëŠ¥ (10,000íšŒ ë°˜ë³µ)

| í•­ëª© | MongoDB | PostgreSQL | ê°œì„ ìœ¨ |
|------|---------|-----------|--------|
| í‰ê·  ì‘ë‹µì‹œê°„ | 8.5ms | 6.2ms | **27% í–¥ìƒ** |
| 99th Percentile | 45ms | 28ms | **38% í–¥ìƒ** |
| ìºì‹œ íˆíŠ¸ìœ¨ | 85% | 92% | **7% í–¥ìƒ** |
| ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ | ì¢‹ìŒ | ë§¤ìš° ì¢‹ìŒ | íŠ¸ëœì­ì…˜ ê²©ë¦¬ |

### ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰

| DB | í¬ê¸° | ìš©ë„ |
|----|------|------|
| PostgreSQL | 125 MB | êµ¬ì¡°í™” ë°ì´í„° |
| MongoDB | 380 MB | ë¹„êµ¬ì¡°í™” ë°ì´í„° |
| **í•©ê³„** | **505 MB** | í•˜ì´ë¸Œë¦¬ë“œ |

## êµí›ˆ ë° ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. ë°ì´í„°ë² ì´ìŠ¤ ì„ íƒ ê¸°ì¤€

**PostgreSQL ì‚¬ìš©**:
- ëª…í™•í•œ ìŠ¤í‚¤ë§ˆ
- ê´€ê³„ ë¬´ê²°ì„± ì¤‘ìš”
- ACID íŠ¸ëœì­ì…˜ í•„ìš”
- SQL ì¡°ì¸ ë¹ˆë²ˆ

**MongoDB ì‚¬ìš©**:
- ìœ ì—°í•œ ìŠ¤í‚¤ë§ˆ
- ë¹ ë¥¸ ì½ê¸°/ì“°ê¸°
- JSON ë°ì´í„° ì €ì¥
- ìˆ˜í‰ í™•ì¥ í•„ìš”

### 2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

1. **ì ì§„ì  ì „í™˜**: í•œ ë²ˆì— ëª¨ë‘ ë°”ê¾¸ì§€ ë§ê³  ë‹¨ê³„ì ìœ¼ë¡œ
2. **ë¡¤ë°± ê³„íš**: í•­ìƒ ì´ì „ ë²„ì „ìœ¼ë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆê²Œ ì¤€ë¹„
3. **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**: ë§ˆì´ê·¸ë ˆì´ì…˜ ì „í›„ ì„±ëŠ¥ ì¸¡ì •
4. **ë°ì´í„° ê²€ì¦**: ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ë°ì´í„° ë¬´ê²°ì„± í™•ì¸

### 3. ì½”ë“œ ë¦¬íŒ©í† ë§

```kotlin
// Good: ì¸í„°í˜ì´ìŠ¤ë¡œ ì¶”ìƒí™”
interface TradingApiPort {
    fun getAccessToken(userId: String): String
}

class KisApiAdapter(
    private val tokenRepository: KisTokenJpaRepository  // êµ¬í˜„ì²´ êµì²´ ê°€ëŠ¥
) : TradingApiPort

// Bad: êµ¬ì²´ í´ë˜ìŠ¤ì— ì˜ì¡´
class KisApiAdapter(
    private val mongoRepository: MongoRepository<KisToken, String>
)
```

## ì°¸ê³  ë¬¸ì„œ

- [KIS_í† í°_ê´€ë¦¬.md](./KIS_í† í°_ê´€ë¦¬.md) - KIS í† í° ê´€ë¦¬ ì‹œìŠ¤í…œ ìƒì„¸
- [ARCHITECTURE.md](./ARCHITECTURE.md) - ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
- [ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md](./ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md) - í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜
