# ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜

**ì•„í‚¤í…ì²˜**: PostgreSQL (ì •í˜•) + MongoDB (ë¹„ì •í˜•) í•˜ì´ë¸Œë¦¬ë“œ
**PostgreSQL**: ê±°ë˜, ì‚¬ìš©ì, stocks ë©”íƒ€ë°ì´í„° ë“± ì •í˜• ë°ì´í„°
**MongoDB**: ML/AI ê²°ê³¼, ë¶„ì„ ë°ì´í„°, daily_stock_data ë“± ë¹„ì •í˜• ë°ì´í„°

---

## ğŸ“Š Stocks ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í˜„í™©

### 1ï¸âƒ£ í˜„ì¬ ìƒíƒœ

#### âœ… PostgreSQL (Primary - ìš°ì„  ì‚¬ìš©)
- **í…Œì´ë¸”**: `stocks` (35ê°œ ë°ì´í„°)
- **ë§ˆì´ê·¸ë ˆì´ì…˜**: Flyway ìë™ ê´€ë¦¬
  - `V6__Create_Stocks_Table.sql`
  - `V7__Insert_Initial_Stocks_Data.sql`
- **Repository**: `StockJpaRepository` (ì™„ì„±)
- **Entity**: `StockEntity.kt` (ì™„ì„±)
- **ìƒíƒœ**: ğŸŸ¡ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¯¸ì ìš©**

**ìŠ¤í‚¤ë§ˆ**:
```sql
CREATE TABLE stocks (
    id BIGSERIAL PRIMARY KEY,
    ticker VARCHAR(20) UNIQUE NOT NULL,
    stock_name VARCHAR(200) NOT NULL,
    stock_name_en VARCHAR(200),
    is_etf BOOLEAN NOT NULL DEFAULT FALSE,
    leverage_ticker VARCHAR(20),
    exchange VARCHAR(50),
    sector VARCHAR(100),
    industry VARCHAR(100),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_stocks_ticker ON stocks(ticker);
CREATE INDEX idx_stocks_is_active ON stocks(is_active);
CREATE INDEX idx_stocks_sector ON stocks(sector);
CREATE INDEX idx_stocks_industry ON stocks(industry);
CREATE INDEX idx_stocks_is_etf ON stocks(is_etf);
```

**ì´ˆê¸° ë°ì´í„° ìƒ˜í”Œ**:
```
AAPL  - ì• í”Œ
MSFT  - ë§ˆì´í¬ë¡œì†Œí”„íŠ¸
NVDA  - ì—”ë¹„ë””ì•„
TSLA  - í…ŒìŠ¬ë¼
QQQ   - QQQ ETF (is_etf=TRUE)
... (ì´ 35ê°œ)
```

#### âœ… MongoDB (ë¹„ì •í˜• ë°ì´í„° ì €ì¥ì†Œ)
- **ì—­í• **: ML/AI ì˜ˆì¸¡ ê²°ê³¼, ë¶„ì„ ë°ì´í„° ë“± ë¹„ì •í˜• ë°ì´í„°
- **ì£¼ìš” ì»¬ë ‰ì…˜**:
  - `daily_stock_data` (7,336ê°œ) - ì¼ë³„ ë³µì¡í•œ ì£¼ì‹ ë°ì´í„°
  - `prediction_results` - Vertex AI ì˜ˆì¸¡ ê²°ê³¼
  - `stock_recommendations` - AI ì¶”ì²œ ê²°ê³¼
  - `sentiment_analysis` - ë‰´ìŠ¤ ê°ì • ë¶„ì„
  - `stock_analysis_results` - ì¢…í•© ë¶„ì„ ê²°ê³¼
- **stocks ì»¬ë ‰ì…˜**: âš ï¸ í˜„ì¬ ë¯¸ì‚¬ìš© (PostgreSQLë¡œ ì „í™˜ ì™„ë£Œ)

---

### 2ï¸âƒ£ ì‚¬ìš© í˜„í™© ë¶„ì„

#### A. StockJpaRepository (PostgreSQL)
**íŒŒì¼**: `StockJpaRepository.kt`

```kotlin
interface StockJpaRepository : JpaRepository<StockEntity, Long> {
    fun findByTicker(ticker: String): StockEntity?
    fun findByIsActive(isActive: Boolean): List<StockEntity>
    fun findByIsEtf(isEtf: Boolean): List<StockEntity>
    fun findBySector(sector: String): List<StockEntity>
    fun findByIndustry(industry: String): List<StockEntity>

    @Query("SELECT s FROM StockEntity s WHERE s.isActive = true ORDER BY s.ticker")
    fun findAllActiveStocks(): List<StockEntity>

    @Query("SELECT s FROM StockEntity s WHERE s.isActive = true AND s.isEtf = false")
    fun findAllActiveNonEtfStocks(): List<StockEntity>

    @Query("SELECT s FROM StockEntity s WHERE s.isActive = true AND s.isEtf = true")
    fun findAllActiveEtfs(): List<StockEntity>
}
```

**ìƒíƒœ**: ğŸŸ¡ ìƒì„± ì™„ë£Œ, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¯¸ì ìš©

#### B. StockRepository (MongoDB)
**íŒŒì¼**: `StockRepository.kt`

```kotlin
interface StockRepository : MongoRepository<Stock, String> {
    fun findByTicker(ticker: String): Stock?
    fun findByIsActive(isActive: Boolean): List<Stock>
}
```

**ìƒíƒœ**: âŒ ì‹¤ì œ í˜¸ì¶œë˜ëŠ” ì½”ë“œ ì—†ìŒ

---

### 3ï¸âƒ£ ê°„ì ‘ ì‚¬ìš© ì„œë¹„ìŠ¤

stocks ë°ì´í„°ë¥¼ **ticker**ë¡œë§Œ ì‹ë³„í•˜ê³  ë©”íƒ€ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì§€ ì•ŠëŠ” ì„œë¹„ìŠ¤:

| ì„œë¹„ìŠ¤ | íŒŒì¼ | Stocks ì‚¬ìš© ë°©ì‹ | ë¬¸ì œì  |
|--------|------|------------------|--------|
| **AutoTradingService** | `AutoTradingService.kt` | `prediction.symbol` (ticker)ë§Œ ì‚¬ìš© | âš ï¸ Stock í™œì„±í™” ì—¬ë¶€ ë¯¸í™•ì¸ |
| **StockRecommendationService** | `StockRecommendationService.kt` | ticker ê¸°ë°˜ ê°„ì ‘ ì°¸ì¡° | âš ï¸ Stock ë©”íƒ€ë°ì´í„° ë¯¸ê²€ì¦ |
| **PredictionController** | `PredictionController.kt` | symbolë¡œ ì¡°íšŒ | âš ï¸ ì¢…ëª© ì •ë³´ ì—†ìŒ |
| **BalanceService** | `BalanceService.kt` | tickerë§Œ ì „ë‹¬ | âš ï¸ ê±°ë˜ ê°€ëŠ¥ ì—¬ë¶€ ë¯¸í™•ì¸ |

**Data Flow**:
```
MongoDB Predictions (symbol: "AAPL")
    â†“
AutoTradingService
    â†“
âŒ Stock ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì—†ì´ ê±°ë˜ ì‹¤í–‰
    â†“
âš ï¸ ë¹„í™œì„± ì¢…ëª© ë˜ëŠ” ETFë„ ê±°ë˜ ê°€ëŠ¥
```

---

### 4ï¸âƒ£ í•„ìš”í•œ ì‘ì—…

#### ğŸ”´ Critical - ì¦‰ì‹œ í•„ìš”

1. **StockService êµ¬í˜„**
   ```kotlin
   @Service
   class StockService(
       private val stockJpaRepository: StockJpaRepository
   ) {
       fun getActiveStock(ticker: String): StockEntity? {
           return stockJpaRepository.findByTicker(ticker)
               ?.takeIf { it.isActive }
       }

       fun getAllActiveStocks(): List<StockEntity> {
           return stockJpaRepository.findAllActiveStocks()
       }

       fun isValidTradingStock(ticker: String): Boolean {
           val stock = stockJpaRepository.findByTicker(ticker)
           return stock != null && stock.isActive && !stock.isEtf
       }
   }
   ```

2. **AutoTradingService ìˆ˜ì •**
   ```kotlin
   @Service
   class AutoTradingService(
       private val stockService: StockService,  // â† ì¶”ê°€
       // ...
   ) {
       fun executeTrade(ticker: String, quantity: Int) {
           // âœ… Stock ê²€ì¦ ì¶”ê°€
           if (!stockService.isValidTradingStock(ticker)) {
               logger.warn("Invalid or inactive stock: $ticker")
               return
           }
           // ê±°ë˜ ì‹¤í–‰
       }
   }
   ```

#### ğŸŸ¡ Important - ë°ì´í„° ë¶„ë¦¬ ëª…í™•í™”

3. **ë°ì´í„° ì €ì¥ì†Œ ì—­í•  ë¶„ë¦¬**
   ```yaml
   # PostgreSQL: ì •í˜• ë°ì´í„°
   - stocks (ë©”íƒ€ë°ì´í„°)
   - users, trading_configs
   - trades, account_balances
   - stock_holdings

   # MongoDB: ë¹„ì •í˜• ë°ì´í„°
   - daily_stock_data (ë³µì¡í•œ ì¼ë³„ ë°ì´í„°)
   - prediction_results (ML ì˜ˆì¸¡)
   - stock_recommendations (AI ì¶”ì²œ)
   - sentiment_analysis (ê°ì • ë¶„ì„)
   ```

4. **MongoDB stocks ì»¬ë ‰ì…˜ ì •ë¦¬**
   - í˜„ì¬: Production ë™ê¸°í™”ë¡œ ìœ ì§€ ì¤‘
   - ëª©í‘œ: ì‚­ì œ (PostgreSQLë¡œ ì™„ì „ ì „í™˜)
   - ì´ìœ : stocksëŠ” ì •í˜• ë°ì´í„°ë¡œ PostgreSQLì´ ì í•©

#### ğŸŸ¢ Optional - ë°ì´í„° í’ˆì§ˆ ê°œì„ 

5. **Stock ë°ì´í„° í™•ì¥**
   ```sql
   -- exchange, sector, industry ì‹¤ì œ ë°ì´í„° ì¶”ê°€
   UPDATE stocks SET
       exchange = 'NASDAQ',
       sector = 'Technology',
       industry = 'Consumer Electronics'
   WHERE ticker = 'AAPL';
   ```

6. **ì™¸ë˜ í‚¤ ì œì•½ ì¶”ê°€**
   ```sql
   ALTER TABLE trades
   ADD CONSTRAINT fk_trades_stock
       FOREIGN KEY (ticker)
       REFERENCES stocks(ticker)
       ON DELETE RESTRICT;
   ```

---

### 5ï¸âƒ£ ì´ˆê¸° ë°ì´í„° ì„¸íŒ… ê°€ì´ë“œ

#### PostgreSQL ìš°ì„  ì‚¬ìš© (ê¶Œì¥)

**1. PostgreSQL stocks í™•ì¸**
```bash
docker compose exec postgresql psql -U quantiq_user -d quantiq \
  -c "SELECT COUNT(*) as stock_count FROM stocks;"
```

ì˜ˆìƒ ê²°ê³¼: `stock_count: 35`

**2. ë°ì´í„° ìƒ˜í”Œ ì¡°íšŒ**
```bash
docker compose exec postgresql psql -U quantiq_user -d quantiq \
  -c "SELECT ticker, stock_name, is_etf, is_active FROM stocks LIMIT 5;"
```

#### MongoDB ë™ê¸°í™” (ë ˆê±°ì‹œ ìœ ì§€ìš©)

**Production â†’ Local ë™ê¸°í™”**
```bash
# stocksë§Œ ë™ê¸°í™”
python scripts/sync_from_prod_mongodb.py --stocks-only --live --force

# stocks + daily_stock_data ë™ê¸°í™”
python scripts/sync_from_prod_mongodb.py --essential --live --force
```

**MongoDB ë°ì´í„° í™•ì¸**
```bash
docker compose exec mongodb mongosh stock_trading \
  --authenticationDatabase admin \
  -u quantiq_user -p quantiq_password \
  --eval "db.stocks.countDocuments({})"
```

---

### 6ï¸âƒ£ í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜ êµ¬ì¶• ë¡œë“œë§µ

```
í˜„ì¬ ìƒíƒœ: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 70%

âœ… Phase 1: ë°ì´í„° ì €ì¥ì†Œ ì—­í•  ë¶„ë¦¬
   - PostgreSQL: ì •í˜• ë°ì´í„° (stocks, users, trades)
   - MongoDB: ë¹„ì •í˜• ë°ì´í„° (predictions, analysis)

âœ… Phase 2: PostgreSQL stocks êµ¬ì¶•
   - stocks í…Œì´ë¸” ìƒì„± ë° ì´ˆê¸° ë°ì´í„°
   - StockJpaRepository êµ¬í˜„
   - Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©

ğŸ”„ Phase 3: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì ìš© (í˜„ì¬ ë‹¨ê³„)
   - StockService êµ¬í˜„
   - AutoTradingServiceì—ì„œ PostgreSQL stocks ì‚¬ìš©
   - Stock ê²€ì¦ ë¡œì§ ì¶”ê°€

ğŸ”œ Phase 4: MongoDB stocks ì •ë¦¬
   - MongoDB StockRepository ì‚­ì œ
   - Stock.kt Domain ì‚­ì œ (ë¹„ì •í˜• ë°ì´í„°ëŠ” ìœ ì§€)
   - Production MongoDBì—ì„œ stocks ì»¬ë ‰ì…˜ ì œê±°

ğŸ”œ Phase 5: í•˜ì´ë¸Œë¦¬ë“œ ì™„ì„±
   - PostgreSQL: ëª¨ë“  ì •í˜• ë°ì´í„°
   - MongoDB: ëª¨ë“  ë¹„ì •í˜• ë°ì´í„°
   - ëª…í™•í•œ ë°ì´í„° ì €ì¥ì†Œ ì—­í•  ë¶„ë¦¬
```

---

### 7ï¸âƒ£ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### PostgreSQL ë°ì´í„° ê²€ì¦
- [ ] stocks í…Œì´ë¸” ì¡´ì¬ í™•ì¸
- [ ] 35ê°œ stocks ë°ì´í„° ì¡´ì¬
- [ ] ticker UNIQUE constraint ì‘ë™
- [ ] 5ê°œ ì¸ë±ìŠ¤ ìƒì„± í™•ì¸
- [ ] is_active=TRUE í™•ì¸

#### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦
- [ ] StockService êµ¬í˜„
- [ ] AutoTradingServiceì—ì„œ Stock ê²€ì¦
- [ ] ë¹„í™œì„± ì¢…ëª© ê±°ë˜ ì°¨ë‹¨
- [ ] ETF ê±°ë˜ ì œí•œ (ì„¤ì •ì— ë”°ë¼)

#### ì„±ëŠ¥ ê²€ì¦
- [ ] ticker ì¡°íšŒ ì„±ëŠ¥ (<10ms)
- [ ] Active stocks ì¡°íšŒ ì„±ëŠ¥ (<50ms)
- [ ] ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸ (EXPLAIN ANALYZE)

---

### 8ï¸âƒ£ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

#### ë¬¸ì œ: stocks í…Œì´ë¸” ì—†ìŒ
```sql
-- Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì¬ì‹¤í–‰
docker compose restart quantiq-core
docker compose logs -f quantiq-core | grep Flyway
```

#### ë¬¸ì œ: stocks ë°ì´í„° ì—†ìŒ
```sql
-- V7 ë§ˆì´ê·¸ë ˆì´ì…˜ í™•ì¸
SELECT * FROM flyway_schema_history WHERE version = '7';

-- ìˆ˜ë™ ë°ì´í„° ì‚½ì…
INSERT INTO stocks (ticker, stock_name, is_etf, is_active)
VALUES ('AAPL', 'ì• í”Œ', FALSE, TRUE)
ON CONFLICT (ticker) DO NOTHING;
```

#### ë¬¸ì œ: MongoDB stocks ë¹„ì–´ìˆìŒ
```bash
# Productionì—ì„œ ì¬ë™ê¸°í™”
python scripts/sync_from_prod_mongodb.py --stocks-only --live --force
```

---

## ğŸ“ ê´€ë ¨ ë¬¸ì„œ

- [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](./ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md)
- [ë§ˆì´ê·¸ë ˆì´ì…˜ íˆìŠ¤í† ë¦¬](./ë§ˆì´ê·¸ë ˆì´ì…˜_íˆìŠ¤í† ë¦¬.md)
- [ì´ˆê¸° ë°ì´í„° ì„¤ì •](../INITIAL_DATA_SETUP.md)
- [RDB ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš](../migration/RDB_MIGRATION_PLAN.md)

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2026-02-01
**ì‘ì„±ì**: Claude Sonnet 4.5
**ìƒíƒœ**: ğŸ”„ ì§„í–‰ ì¤‘ (60% ì™„ë£Œ)
