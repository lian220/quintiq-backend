# ğŸ—ï¸ í•˜ì´ë¸Œë¦¬ë“œ ë°ì´í„°ë² ì´ìŠ¤ ì „ëµ

**ì•„í‚¤í…ì²˜**: PostgreSQL (ì •í˜•) + MongoDB (ë¹„ì •í˜•)

---

## ğŸ¯ ì„¤ê³„ ì›ì¹™

### ë°ì´í„° ì €ì¥ì†Œ ì„ íƒ ê¸°ì¤€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë°ì´í„° ìœ í˜• íŒë‹¨ ê¸°ì¤€                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  ì •í˜• ë°ì´í„° (PostgreSQL)                       â”‚
â”‚  âœ… ê³ ì •ëœ ìŠ¤í‚¤ë§ˆ                               â”‚
â”‚  âœ… íŠ¸ëœì­ì…˜ í•„ìš”                               â”‚
â”‚  âœ… ê´€ê³„í˜• ë°ì´í„°                               â”‚
â”‚  âœ… ACID ë³´ì¥ í•„ìš”                              â”‚
â”‚  âœ… SQL ì¡°ì¸ í•„ìš”                               â”‚
â”‚                                                  â”‚
â”‚  ë¹„ì •í˜• ë°ì´í„° (MongoDB)                        â”‚
â”‚  âœ… ìœ ë™ì ì¸ ìŠ¤í‚¤ë§ˆ                             â”‚
â”‚  âœ… ë³µì¡í•œ nested structure                     â”‚
â”‚  âœ… ML/AI ê²°ê³¼ (JSON)                           â”‚
â”‚  âœ… ëŒ€ìš©ëŸ‰ ë¡œê·¸/ë¶„ì„ ë°ì´í„°                     â”‚
â”‚  âœ… ë¹ ë¥¸ ì½ê¸°/ì“°ê¸°                              â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ë°ì´í„° ë¶„ë¥˜

### PostgreSQL - ì •í˜• ë°ì´í„°

| í…Œì´ë¸” | ë°ì´í„° ìœ í˜• | ì´ìœ  |
|--------|-------------|------|
| **stocks** | ì£¼ì‹ ë©”íƒ€ë°ì´í„° | ê³ ì • ìŠ¤í‚¤ë§ˆ, ê´€ê³„í˜•, ìì£¼ ì¡°ì¸ |
| **users** | ì‚¬ìš©ì ì •ë³´ | ACID í•„ìš”, ì¸ì¦ ë°ì´í„° |
| **trading_configs** | ê±°ë˜ ì„¤ì • | users FK, íŠ¸ëœì­ì…˜ |
| **trades** | ê±°ë˜ ë‚´ì—­ | ACID í•„ìˆ˜, ê¸ˆìœµ ë°ì´í„° |
| **account_balances** | ê³„ì¢Œ ì”ê³  | íŠ¸ëœì­ì…˜, ì •í•©ì„± ì¤‘ìš” |
| **stock_holdings** | ë³´ìœ  ì£¼ì‹ | users/stocks FK |
| **kis_tokens** | KIS í† í° | ë³´ì•ˆ ë°ì´í„°, ì•”í˜¸í™” |

**íŠ¹ì§•**:
- âœ… ê³ ì •ëœ ìŠ¤í‚¤ë§ˆ
- âœ… ACID íŠ¸ëœì­ì…˜ ë³´ì¥
- âœ… ì™¸ë˜ í‚¤ ì œì•½
- âœ… ë³µì¡í•œ ì¡°ì¸ ì¿¼ë¦¬
- âœ… ë°ì´í„° ì •í•©ì„± ì¤‘ìš”

### MongoDB - ë¹„ì •í˜• ë°ì´í„°

| ì»¬ë ‰ì…˜ | ë°ì´í„° ìœ í˜• | ì´ìœ  |
|--------|-------------|------|
| **daily_stock_data** | ì¼ë³„ ì£¼ì‹ ë°ì´í„° | ë³µì¡í•œ nested, ë¹ ë¥¸ ì“°ê¸° |
| **prediction_results** | Vertex AI ì˜ˆì¸¡ | JSON ê²°ê³¼, ìœ ë™ì  ìŠ¤í‚¤ë§ˆ |
| **stock_recommendations** | AI ì¶”ì²œ ê²°ê³¼ | ê¸°ìˆ ì  ì§€í‘œ (ë™ì  í•„ë“œ) |
| **sentiment_analysis** | ê°ì • ë¶„ì„ | ë‰´ìŠ¤ ë°ì´í„°, ë¹„ì •í˜• |
| **stock_analysis_results** | ì¢…í•© ë¶„ì„ | ë³µì¡í•œ ë¶„ì„ ê²°ê³¼ |

**íŠ¹ì§•**:
- âœ… ìœ ë™ì  ìŠ¤í‚¤ë§ˆ
- âœ… ë³µì¡í•œ nested documents
- âœ… ëŒ€ìš©ëŸ‰ ë¡œê·¸ ë°ì´í„°
- âœ… ë¹ ë¥¸ ì½ê¸°/ì“°ê¸°
- âœ… ML/AI JSON ê²°ê³¼

---

## ğŸ”„ ë°ì´í„° íë¦„

### ì •í˜• ë°ì´í„° íë¦„ (PostgreSQL)

```
ì‚¬ìš©ì ê±°ë˜ ìš”ì²­
    â†“
1. users í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì í™•ì¸
    â†“
2. stocks í…Œì´ë¸”ì—ì„œ ì¢…ëª© ê²€ì¦
    â†“
3. trading_configsì—ì„œ ê±°ë˜ ì„¤ì • í™•ì¸
    â†“
4. trades í…Œì´ë¸”ì— ê±°ë˜ ê¸°ë¡ (ACID)
    â†“
5. account_balances ì—…ë°ì´íŠ¸ (ACID)
    â†“
6. stock_holdings ì—…ë°ì´íŠ¸ (ACID)

âœ… íŠ¸ëœì­ì…˜ìœ¼ë¡œ ëª¨ë‘ ì„±ê³µ ë˜ëŠ” ë¡¤ë°±
```

### ë¹„ì •í˜• ë°ì´í„° íë¦„ (MongoDB)

```
ML/AI ë¶„ì„ ìš”ì²­
    â†“
1. daily_stock_dataì—ì„œ historical ë°ì´í„° ì¡°íšŒ
    â†“
2. Vertex AI ì˜ˆì¸¡ ì‹¤í–‰
    â†“
3. prediction_resultsì— JSON ê²°ê³¼ ì €ì¥
    â†“
4. stock_recommendations ìƒì„± (ê¸°ìˆ ì  ì§€í‘œ í¬í•¨)
    â†“
5. sentiment_analysis ì¶”ê°€
    â†“
6. stock_analysis_results ì¢…í•© (ëª¨ë“  ë¶„ì„ í†µí•©)

âœ… ê° ë‹¨ê³„ëŠ” ë…ë¦½ì , ë¹ ë¥¸ ì“°ê¸°
```

---

## ğŸ”— í•˜ì´ë¸Œë¦¬ë“œ ì—°ë™

### stocks ë°ì´í„° ì°¸ì¡°

**PostgreSQL stocks (Source of Truth)**:
```kotlin
// ê±°ë˜ ì‹œ ì¢…ëª© ê²€ì¦
val stock = stockJpaRepository.findByTicker("AAPL")
if (stock == null || !stock.isActive) {
    throw InvalidStockException("Invalid or inactive stock")
}
```

**MongoDBì—ì„œ ì°¸ì¡°**:
```kotlin
// ì˜ˆì¸¡ ê²°ê³¼ì— tickerë§Œ ì €ì¥
val prediction = PredictionResult(
    symbol = "AAPL",  // â† PostgreSQL stocksì˜ ticker ì°¸ì¡°
    prediction = 150.5,
    confidence = 0.85
)
predictionRepository.save(prediction)
```

**ì¡°ì¸ íŒ¨í„´**:
```kotlin
// Application Layerì—ì„œ ì¡°í•©
fun getStockWithPredictions(ticker: String): StockWithPrediction {
    val stock = stockJpaRepository.findByTicker(ticker)  // PostgreSQL
    val predictions = predictionRepository.findBySymbol(ticker)  // MongoDB
    return StockWithPrediction(stock, predictions)
}
```

---

## ğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

### stocks ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (ì™„ë£Œ)

**Before (MongoDB Only)**:
```kotlin
@Document(collection = "stocks")
data class Stock(
    @Id val id: String?,
    val ticker: String,
    val stockName: String,
    // ...
)

interface StockRepository : MongoRepository<Stock, String>
```

**After (PostgreSQL + MongoDB Hybrid)**:
```kotlin
// PostgreSQL (ì •í˜• ë©”íƒ€ë°ì´í„°)
@Entity
@Table(name = "stocks")
data class StockEntity(
    @Id @GeneratedValue val id: Long?,
    @Column(unique = true) val ticker: String,
    val stockName: String,
    // ...
)

interface StockJpaRepository : JpaRepository<StockEntity, Long>

// MongoDB (ë¹„ì •í˜• ë¶„ì„ ë°ì´í„°ë§Œ)
@Document(collection = "prediction_results")
data class PredictionResult(
    @Id val id: String?,
    val symbol: String,  // â† PostgreSQL stocks.ticker ì°¸ì¡°
    // ...
)
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. MongoDB stocks ì»¬ë ‰ì…˜ ì‚­ì œ ì˜ˆì •

**í˜„ì¬ ìƒíƒœ**:
- MongoDB stocks: 35ê°œ ë°ì´í„° (ë¯¸ì‚¬ìš©)
- PostgreSQL stocks: 35ê°œ ë°ì´í„° (í™œìš© ì¤‘)

**ì‚­ì œ ê³„íš**:
```bash
# âš ï¸ ì£¼ì˜: ì‹¤ì œ ì‹¤í–‰ ì „ ë°±ì—… í•„ìˆ˜
# MongoDB stocks ì»¬ë ‰ì…˜ ì‚­ì œ
docker compose exec mongodb mongosh stock_trading \
  --authenticationDatabase admin \
  -u quantiq_user -p quantiq_password \
  --eval "db.stocks.drop()"
```

### 2. ë°ì´í„° ì •í•©ì„± ìœ ì§€

**tickerë¥¼ ê³µí†µ í‚¤ë¡œ ì‚¬ìš©**:
- PostgreSQL stocks.ticker (Primary Key)
- MongoDB collectionsì˜ symbol/ticker í•„ë“œ (Reference)

**ì •í•©ì„± ê·œì¹™**:
1. PostgreSQL stocksì— ì—†ëŠ” tickerëŠ” MongoDBì— ì €ì¥ ê¸ˆì§€
2. stocks.is_active = falseë©´ ì˜ˆì¸¡/ë¶„ì„ ì¤‘ë‹¨
3. ticker ë³€ê²½ ì‹œ ì–‘ìª½ ëª¨ë‘ ì—…ë°ì´íŠ¸

### 3. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

**PostgreSQL**:
- ì¸ë±ìŠ¤: ticker, is_active, sector, industry
- ì¡°ì¸ ì¿¼ë¦¬ ìµœì í™”
- íŠ¸ëœì­ì…˜ ë²”ìœ„ ìµœì†Œí™”

**MongoDB**:
- symbol í•„ë“œ ì¸ë±ìŠ¤
- ë³µí•© ì¸ë±ìŠ¤: {symbol: 1, date: -1}
- ìƒ¤ë”© ê³ ë ¤ (ëŒ€ìš©ëŸ‰ ì‹œ)

---

## ğŸ“Š í˜„ì¬ êµ¬í˜„ ìƒíƒœ

### âœ… ì™„ë£Œ (2026-02-01)
- âœ… **PostgreSQL stocks í…Œì´ë¸” ìƒì„± ë° ë§ˆì´ê·¸ë ˆì´ì…˜**
  - 35ê°œ ì¢…ëª© ë°ì´í„° MongoDB â†’ PostgreSQL ì „í™˜ ì™„ë£Œ
  - StockJpaRepository êµ¬í˜„ ë° í™œì„±í™”
  - Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- âœ… **MongoDB ë¹„ì •í˜• ë°ì´í„° ì»¬ë ‰ì…˜ ìµœì í™”**
  - prediction_results: 781,923ê±´
  - stock_recommendations: 2,571ê±´
  - sentiment_analysis: 2,328ê±´
  - daily_stock_data: 22,002ê±´
- âœ… **í•˜ì´ë¸Œë¦¬ë“œ êµ¬ì¡° ì™„ì„±**
  - PostgreSQL: ì •í˜• ë©”íƒ€ë°ì´í„° (stocks, users, holdings, balances)
  - MongoDB: ë¹„ì •í˜• ë¶„ì„ ë°ì´í„° (predictions, sentiment, daily_data)
  - Application Layerì—ì„œ ì¡°í•© ì¿¼ë¦¬ êµ¬í˜„
- âœ… **StockService ë° AutoTradingService êµ¬í˜„**
  - PostgreSQL stocksë¥¼ Source of Truthë¡œ ì‚¬ìš©
  - MongoDBì—ì„œ ticker ì°¸ì¡° ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ì—°ë™

### ğŸ”„ ì§„í–‰ ì¤‘
- ğŸ“Š **MongoDB stocks ì»¬ë ‰ì…˜ ì •ë¦¬** (ì„ íƒ ì‚¬í•­)
  - í˜„ì¬: 35ê°œ ë°ì´í„° ìœ ì§€ (ë¯¸ì‚¬ìš©)
  - ê³„íš: ë°±ì—… í›„ ì‚­ì œ ê³ ë ¤
- ğŸ” **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ìµœì í™”**
  - PostgreSQL ì¡°ì¸ ì¿¼ë¦¬ ì„±ëŠ¥ ì¸¡ì •
  - MongoDB ì¸ë±ìŠ¤ ìµœì í™”

### ğŸ”œ ì˜ˆì •
- ğŸ“ˆ **ì„±ëŠ¥ ìµœì í™” ê°€ì´ë“œ ì‘ì„±**
- ğŸ” **ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ êµ¬ì¶•**

---

## ğŸ“ ê´€ë ¨ ë¬¸ì„œ

- [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](./ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md)
- [ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ í˜„í™©](./ë°ì´í„°ë² ì´ìŠ¤_ë§ˆì´ê·¸ë ˆì´ì…˜_í˜„í™©.md)
- [ì´ˆê¸° ë°ì´í„° ì„¤ì •](../setup/ì´ˆê¸°_ë°ì´í„°_ì„¤ì •.md)
- [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](../database/SCHEMA.md)
- [í…Œì´ë¸” ê´€ê³„ë„](../database/RELATIONSHIPS.md)

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2026-02-01 19:30 KST
**ì‘ì„±ì**: Claude Sonnet 4.5
**ì•„í‚¤í…ì²˜ ìœ í˜•**: PostgreSQL (ì •í˜•) + MongoDB (ë¹„ì •í˜•) í•˜ì´ë¸Œë¦¬ë“œ
**ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ**: âœ… ì™„ë£Œ (Stock: MongoDB â†’ PostgreSQL)
